# 变更说明 — PyQt6 GUI 实现（Future 阶段）

**日期**：2026-02-26
**测试数**：186 → 213（+27）

---

## 1. 变更概要

实现 ai-trainer-gen 的 PyQt6 图形界面层（Future 阶段），采用 MVVM 架构：

- **ViewModels**（纯 Python，无 Qt 依赖）：17 个单元测试
- **Qt Widgets**（4 页面 + MainWindow）：10 个组件测试（offscreen 渲染）

完成后全部 **213 个**测试通过，耗时 < 0.5 s。

---

## 2. 涉及文件

### 新增

| 文件 | 说明 |
|------|------|
| `src/gui/__init__.py` | 包入口，导出 `MainWindow` |
| `src/gui/viewmodels.py` | 5 个 ViewModel 类（ProcessList / FeatureConfig / Generate / ScriptManager） |
| `src/gui/main_window.py` | QMainWindow + QStackedWidget，4 页面导航 |
| `src/gui/pages/__init__.py` | 页面包入口 |
| `src/gui/pages/process_select.py` | 进程选择页（QListWidget + QLineEdit + Refresh/Select 按钮） |
| `src/gui/pages/feature_config.py` | 功能配置页（QCheckBox × 8 + QLineEdit + Generate 按钮） |
| `src/gui/pages/generate.py` | 生成监控页（QPlainTextEdit + QProgressBar + Back 按钮） |
| `src/gui/pages/script_manager.py` | 脚本管理页（QTableWidget + 搜索 + Export/Back 按钮） |
| `tests/unit/test_gui_viewmodels.py` | 17 个 ViewModel 单元测试 |
| `tests/unit/test_gui_widgets.py` | 10 个 Qt 组件测试（offscreen） |

### 修改

| 文件 | 说明 |
|------|------|
| `PROJECT_PLAN.md` | 测试数更新至 213，Future/GUI 标记 ✅ 完成，补充实现细节 |

---

## 3. 实现原理

### MVVM 分层

```
Qt Widgets  ←─ 读取/写入 ──→  ViewModels  ←─ (future) ──→  Services / Store
(有 Qt 依赖)                  (纯 Python)
```

**ViewModel 层**不导入任何 Qt 模块，因此可以在无显示设备的 CI 环境直接测试业务逻辑。

**Widget 层**通过 `QT_QPA_PLATFORM=offscreen` 启用离屏渲染，同样可以在无 GUI 的环境运行。

### 页面导航

`MainWindow` 持有一个 `QStackedWidget`，页面索引：

| 索引 | 页面 |
|------|------|
| 0 | ProcessSelectPage |
| 1 | FeatureConfigPage |
| 2 | GeneratePage |
| 3 | ScriptManagerPage |

`_connect_navigation()` 把各页面的按钮 `clicked` 信号连接到 `go_to(index)`，实现向导式导航。

### FeatureConfigViewModel.toggle()

```python
def toggle(self, feature: str) -> None:
    if feature in self.selected_features:
        self.selected_features.remove(feature)
    else:
        self.selected_features.append(feature)
```

UI 层的 `toggled` 信号判断 `checked` 状态后决定是否调用 `toggle()`，避免重复切换。

### GenerateViewModel 状态机

```
IDLE ──start()──→ RUNNING ──finish()──→ DONE
                     │
                   error(msg)
                     │
                     ▼
                   ERROR
```

---

## 4. 测试变化

### `tests/unit/test_gui_viewmodels.py`（+17）

| 类 | 测试方法 | 覆盖点 |
|----|---------|--------|
| `TestProcessListViewModel` | 5 | 初始状态、过滤、大小写不敏感、select、filtered_processes 空字串 |
| `TestFeatureConfigViewModel` | 5 | standard_features 长度、toggle 添加/移除、has_selection（功能/自定义/空） |
| `TestGenerateViewModel` | 4 | append_log、set_progress 边界、start() 重置、finish()/error() 状态 |
| `TestScriptManagerViewModel` | 3 | load() 重置选中、visible_records 过滤、大小写不敏感搜索 |

### `tests/unit/test_gui_widgets.py`（+10）

使用 `module` 作用域的单一 `QApplication` fixture，避免多实例冲突。

| 类 | 测试 |
|----|------|
| `TestMainWindow` | 创建无异常、含 QStackedWidget |
| `TestProcessSelectPage` | 含 QListWidget、含 Refresh 按钮 |
| `TestFeatureConfigPage` | QCheckBox ≥ 3、含 Generate 按钮 |
| `TestGeneratePage` | 含 QTextEdit/QPlainTextEdit、含 QProgressBar |
| `TestScriptManagerPage` | 含 QTableWidget、含 Export 按钮 |

---

## 5. 下一步

所有计划阶段（Week 1–4 + Future GUI）均已完成，共 213 个测试。

潜在后续工作：

| 方向 | 内容 |
|------|------|
| 端到端集成 | 将 GUI `Generate →` 按钮连接到完整 Detector→Dumper→Analyzer→CE Wrapper 流水线 |
| 真实进程注入 | Windows 环境下测试 CE COM 接口（`com_bridge.py`） |
| LLM 集成测试 | 用真实 Claude/OpenAI API 替换 Stub 后端 |
| 打包发布 | `python -m build` 生成 wheel + PyInstaller 打包可执行文件 |
| Dark Mode | 为 PyQt6 GUI 添加主题切换 |
